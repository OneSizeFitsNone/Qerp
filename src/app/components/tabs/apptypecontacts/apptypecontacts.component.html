
<form class="row">

    <div class="form-group col-lg-3 col-md-6 col-sm-8">
        <mat-form-field style="width: 100%;">
            <mat-label>{{ "general.search" | translate }}</mat-label>
            <input matInput name="crSearch" [(ngModel)]="ccSearch" (ngModelChange)="onInputChange()">
        </mat-form-field>
    </div>

    <div class="form-group col-lg-9 col-md-6 col-sm-4 d-flex align-items-center">
        <div class="box">
            <a *ngIf="sourceAppTypeId == null" href="javascript:void(0);" (click)="onCreateApptypecontact()">
                <i *ngIf="!hasNew"
                    class="fa fa-plus-square searchformicon cursor" data-toggle="tooltip" data-animation="false"
                    data-placement="bottom" title="{{ 'general.add' | translate }}"
                ></i>
            </a>
            <a *ngIf="sourceAppTypeId != null && appTypeId == appTypes.prospect " href="javascript:void(0);" 
                [routerLink]="['/pages/pm/prospect', 0]" [queryParams]="{st: sourceAppTypeId, sl: sourceLinkTypeId}">
                <i *ngIf="!hasNew"
                    class="fa fa-plus-square searchformicon cursor" data-toggle="tooltip" data-animation="false"
                    data-placement="bottom" title="{{ 'general.add' | translate }}"
                ></i>
            </a>
            <a *ngIf="sourceAppTypeId != null && appTypeId == appTypes.project " href="javascript:void(0);" 
                [routerLink]="['/pages/pm/project', 0]" [queryParams]="{st: sourceAppTypeId, sl: sourceLinkTypeId}">
                <i *ngIf="!hasNew"
                    class="fa fa-plus-square searchformicon cursor" data-toggle="tooltip" data-animation="false"
                    data-placement="bottom" title="{{ 'general.add' | translate }}"
                ></i>
            </a>
        </div>
    </div> 

</form>

<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th *ngIf="sourceAppTypeId != null">
                    <ng-container *ngIf="appTypeId == appTypes.prospect">{{ "prospect" | translate }}</ng-container>
                    <ng-container *ngIf="appTypeId == appTypes.project">{{ "project" | translate }}</ng-container>
                </th>
                <th *ngIf="sourceAppTypeId != appTypes.contact">{{ "contact" | translate }}</th>
                <th *ngIf="sourceAppTypeId != appTypes.client">{{ "company" | translate }}</th>
                <th>{{ "contactroles.role" | translate }}</th>
                <th>{{ "general.description" | translate }}</th>
                <th>{{ "general.created" | translate }}</th>
                <th>{{ "general.updated" | translate }}</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <ng-container *ngFor="let ocr of apptypecontactSearch">

                <tr>

                    <td *ngIf="sourceAppTypeId != null">

                        <span *ngIf="appTypeId == appTypes.prospect">
                            <a [routerLink]="['/pages/pm/prospect', ocr.linkedId]" href="javascript:void(0)">
                                {{ ocr.prospect?.number }}
                            </a>
                        </span>

                        <span *ngIf="appTypeId == appTypes.project">
                            <a [routerLink]="['/pages/pm/project', ocr.linkedId]" href="javascript:void(0)">
                                {{ ocr.project?.number }}
                            </a>
                        </span>
                    </td>
                    <td *ngIf="sourceAppTypeId != appTypes.contact">
                        <span *ngIf="apptypecontact?.id != ocr.id">
                            <a [routerLink]="['/pages/crm/contact', ocr.contactId]" href="javascript:void(0)">{{ ocr.contact?.fullname }}</a>
                        </span>
                        <mat-form-field *ngIf="apptypecontact?.id == ocr.id" class="mat-field">
                            <mat-select placeholder="{{ 'contact.select' | translate}}" [(ngModel)]="apptypecontact.contactId" (openedChange)="searchcontact.focus()">
                                <mat-form-field class="mat-field">
                                    <input #searchcontact matInput placeholder="{{ 'general.search' | translate }}" [(ngModel)]="contactSearch" 
                                        (input)="onSearchContact($event.target.value)" (keydown)="$event.stopPropagation()">
                                    <a href="javascript:void(0)" (click)="onEnterSearch('contact')">
                                        <i *ngIf="contactSearch.length > 2" class="fa fa-plus-square cursor"></i>
                                    </a>                                            
                                </mat-form-field>
                                <mat-option hidden [value]="null"></mat-option>
                                <mat-option *ngFor="let contact of contacts" [value]="contact.id">{{ contact.fullname }}</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>
                    <td *ngIf="sourceAppTypeId != appTypes.client">
                        <span *ngIf="apptypecontact?.id != ocr.id">
                            <a [routerLink]="['/pages/crm/company', ocr.clientId]" href="javascript:void(0)">{{ ocr.client?.name }}</a>
                        </span>
                        <mat-form-field *ngIf="apptypecontact?.id == ocr.id" class="mat-field">
                            <mat-select placeholder="{{ 'company.select' | translate}}" [(ngModel)]="apptypecontact.clientId" (openedChange)="searchcompany.focus()">
                                <mat-form-field class="mat-field">
                                    <input #searchcompany matInput placeholder="{{ 'general.search' | translate }}" [(ngModel)]="companySearch" 
                                        (input)="onSearchCompany($event.target.value)" (keydown)="$event.stopPropagation()">
                                    <a href="javascript:void(0)" (click)="onEnterSearch('company')">
                                        <i *ngIf="companySearch.length > 2" class="fa fa-plus-square cursor"></i>
                                    </a>                                            
                                </mat-form-field>
                                
                                <mat-option hidden [value]="null"></mat-option>
                                <mat-option *ngFor="let company of companies" [value]="company.id">{{ company.name }}</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>

                    <td>
                        <span *ngIf="apptypecontact?.id != ocr.id">
                            {{ ocr.contactrole?.name }}
                        </span>
                        <mat-form-field *ngIf="apptypecontact?.id == ocr.id" class="mat-field">
                            <mat-select placeholder="{{ 'contactroles.select' | translate}}" [(ngModel)]="apptypecontact.contactroleId" (openedChange)="searchrole.focus()">  
                                <mat-form-field class="mat-field">
                                    <input #searchrole matInput placeholder="{{ 'general.search' | translate }}" [(ngModel)]="roleSearch" 
                                        (input)="onSearchRole($event.target.value)" (keydown)="$event.stopPropagation()">
                                    <a href="javascript:void(0)" (click)="onEnterSearchContactrole()">
                                        <i *ngIf="roleSearch.length > 2" class="fa fa-plus-square cursor"></i>
                                    </a>
                                </mat-form-field>                               

                                <mat-option *ngFor="let roles of contactroleSearch" [value]="roles.id">{{ roles.name }}</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </td>

                    <td style="white-space: pre-wrap;">
                        <span *ngIf="apptypecontact?.id != ocr.id">
                            {{ ocr.description }}
                        </span>
                        <mat-form-field *ngIf="apptypecontact?.id == ocr.id" class="mat-field">
                            <textarea matInput [(ngModel)]="apptypecontact.description" rows="2"></textarea>
                        </mat-form-field>
                    </td>

                    <td>{{ ocr.created | date:"dd/MM/yyyy HH:mm" }}</td>
                    <td>{{ ocr.updated | date:"dd/MM/yyyy HH:mm" }}</td>
                    <td>
                        <i *ngIf="ocr.id!=apptypecontact.id" class="fa fa-edit cursor mr-2" (click)="editApptypecontact(ocr)"></i>
                        <i *ngIf="ocr.id==apptypecontact.id" class="fa fa-save cursor mr-2" (click)="saveApptypecontact(apptypecontact)"></i>
                        <i class="fa fa-trash-o cursor" (click)="deleteApptypecontact(ocr)"></i>
                    </td>

                </tr>

            </ng-container>
        </tbody>
    </table>
</div>